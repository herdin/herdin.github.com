---
layout: post
title: "Vault 맛보기"
date: 2019-09-17
tags: vault writing
---

[공식 문서](https://www.vaultproject.io/docs/install/)

# 설치부터 해보자

### 다운을 받자

`/tools/vault` 폴더를 만들고 거기에 설치할 계획이다.  
`docker` 버전으로 기동을 한다고해도 `vault cli` 때문이라도 깔아놓자.

``` shell
#download vault 1.1.2
$ wget https://releases.hashicorp.com/vault/1.1.2/vault_1.1.2_linux_amd64.zip
$ mkdir /tools/vault
$ unzip vault_1.1.2_linux_amd64.zip -d /tools/vault
```

### 압축풀었으면 환경변수를 세팅하자.

``` shell
#setting vault path
$ cd ~
$ vim .bashrc

#>>>>>>>>>>>>>> editor start
export VAULT_HOME=/tools/vault
export PATH=${VAULT_HOME}:${PATH}
export VAULT_ADDR='http://127.0.0.1:8200'
export VAULT_ROOT_TOKEN=''
#<<<<<<<<<<<<<< editor end

$ source .bashrc
```

### 설치가 잘되었는지 vault cli 를 사용해보자

``` shell
#verifying the installation
$ vault
#set vault autocomplete to bash
$ vault -autocomplete-install
$ exec $SHELL
```

### 개발모드란게 있지만..

``` shell
#run vault server dev mode
$ vault server -dev
```

> 사용해본적은 없다.

### 운영모드로 세팅해보자

> config.hcl

``` shell
storage "file" {
  path = "/mnt/vault/data"
}

listener "tcp" {
  address = "0.0.0.0:8200"
  tls_disable = false
}

ui = true
```

`ui = true` 옵션을 넣었기 떄문에 `vault ui url = http://host.domain.name:8200/ui` 에 접속했을 경우 웹 페이지가 나와야한다.

# 세팅을 했으면 기동을 해보자

1. `non-docker` 버전으로 아래와 같이 실행을 하던지,

``` shell
$ vault server -config=config.hcl
$ vault operator init
```

2. `docker` 버전으로 아래와 같이 실행을 하자.

``` shell
#config init
$ docker run
 --cap-add=IPC_LOCK
 -e 'VAULT_LOCAL_CONFIG={"backend": {"file": {"path": "/vault/file"}}, "listener": {"tcp": { "address": "0.0.0.0:8200", "tls_disable": "true"}}, "ui": "true", "default_lease_ttl": "168h", "max_lease_ttl": "720h"}'
 -d
 -p 8200:8200
 --name=dev-vault
 docker.io/vault:1.1.2 server
```

### Unseal 을 해보자

초기에 vault 가 실행되거나 재기동이 되면 sealed 상태가 되어 사용할 수 없게 된다.  
이때 사용할 수 있는 명령은 status, operator init 뿐인듯.  
unseal key 5개 중 아무거나 3개로 unseal 하여 사용하자.  
root key 는 잘 숨겨놓자.

``` shell
Unseal Key 1: zmQlHaFap7yo/onSXDLGtzUQwz/cgNc3igd7dvSsPl9M
Unseal Key 2: 0R1XXjz2szSJW3q05eapTs2ST6npYsHROHEr0l1aMyez
Unseal Key 3: 5YwtvQcIP+VzX/TMkb0UDSaw+R9ZDftx3eDAmHn7Tn8Q
Unseal Key 4: 45mBEZsh4dC71EUq2SXgC7owz3NFx04cqaQEMlDp1Yqo
Unseal Key 5: HP18QROkknaL8ZAyMFfMZmBh/cxuKfUiq/Zx9nOlW8Bj

Initial Root Token: s.syVRoWESdXjZU0iaPDXROlEv

$ vault operator unseal
Unseal Key (will be hidden):
```

# 이제 설치 끝! 사용해보자

### secret engine 을 활성화 하자

단순하게 사용할거니까 `KV Secrets Engine - Version 2` 를 활성화 시킨다.  
> Version 1 과 Version 2 의 차이점은 모른다. 더 높은걸 써본다.

``` shell
$ vault secrets enable -version=2 kv
Success! Enabled the kv secrets engine at: kv/
```

### 데이터를 넣어보자

`KV Secret Engine` 을 활성화 시켰으니 데이터를 넣어본다.

``` shell
$ vault kv put kv/hello foo=world
Key              Value
---              -----
created_time     2019-09-17T08:02:59.596377968Z
deletion_time    n/a
destroyed        false
version          1

$ vault kv get kv/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T08:02:59.596377968Z
deletion_time    n/a
destroyed        false
version          1

=== Data ===
Key    Value
---    -----
foo    world
```

### 확인했으니 데이터를 지워본다.

``` shell
$ vault kv delete kv/hello
Success! Data deleted (if it existed) at: kv/hello

$ vault kv get kv/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T08:02:59.596377968Z
deletion_time    2019-09-17T08:09:49.431250098Z
destroyed        false
version          1

```

### secret engine 에 custom path 를 줘보자

위에서 `KV Secrets Engine - Version 2` 에 `path` 를 주지 않아 기본적으로 `kv` 라는 명칭으로 엔진이 활성화 되었다.  
이번에는 `my-secret` 이란 명칭의 `KV Secrets Engine - Version 2` 를 하나 더 활성화 시켜본다.

``` shell
$ vault secrets enable -version=2 -path my-secret kv
Success! Enabled the kv secrets engine at: my-secret/
```

### 활성화 시켰으니 쓰고 읽어보자

``` shell
$ vault kv put my-secret/hello foo=bar
Key              Value
---              -----
created_time     2019-09-17T08:12:23.438008623Z
deletion_time    n/a
destroyed        false
version          1

$ vault kv get my-secret/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T08:12:23.438008623Z
deletion_time    n/a
destroyed        false
version          1

=== Data ===
Key    Value
---    -----
foo    bar
```

### secret engine 비활성화
아까 만든 기본 명칭의 `KV Secrets Engine - Version 2` 를 삭제해 보자.  
먼저 어떤 `secret` 엔진이 있는지 확인 하고 지우고 다시 확인해 본다.

``` shell
$ vault secrets list
Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_db8771ab    per-token private secret storage
identity/     identity     identity_139be64f     identity store
kv/           kv           kv_308395a9           n/a
my-secret/    kv           kv_f7494446           n/a
sys/          system       system_b5319d41       system endpoints used for control, policy and debugging

$ vault secrets disable kv
Success! Disabled the secrets engine (if it existed) at: kv/

$ vault secrets list
Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_db8771ab    per-token private secret storage
identity/     identity     identity_139be64f     identity store
my-secret/    kv           kv_f7494446           n/a
sys/          system       system_b5319d41       system endpoints used for control, policy and debugging
```
