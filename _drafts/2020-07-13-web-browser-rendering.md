---
layout: post
title: "브라우저 렌더링"
date: 2020-07-13
tags: web
---

#### 엔진
* 파이어폭스는 모질라에서 만든 게코(Gecko) 엔진을 사용
* 사파리, 크롬은 웹킷(Webkit) 엔진을 사용

#### 동작과정
* HTML 문서 파싱
* 렌더 트리 구축
  * 콘텐츠 트리 내부에서 태그를 DOM 노드로 변환
  * CSS 파일 파싱
* 렌더 트리 배치
* 렌더 트리 그리기

> 렌더링 엔진은 좀 더 나은 사용자 경험을 위해, HTML 파싱과 배치, 그리기를 동시에 진행한다.  
> 네트워크로로 부터 모든 자원을 받기 전에 일부를 먼저 화면에 표시한다.

##### 용어 비교
* 웹킷 - 게코
* 렌더트리(render tree) - 형상트리(frame tree)
* 요소 배치(layout) - 리플로(reflow)
* 어태치먼트(attachment) - 콘텐츠 싱크(content sink)

#### 파싱
> [문맥 자유 문법](https://ko.wikipedia.org/wiki/%EB%AC%B8%EB%A7%A5_%EC%9E%90%EC%9C%A0_%EB%AC%B8%EB%B2%95) : 모든 형식은 정해진 용어와 구문 규칙에 따라야 한다.

* 어휘 분석 - 자료를 토큰으로 분해하는 과정
* 구문 분석 - 언어의 구문 규칙을 적용하는 과정

하지만, HTML 은 문맥 자유 문법이 아니다. 암묵적인 태그 생략 등을 '너그럽게' 용서해주기 떄문이다. 이 차이가 HTML 이 인기가 있었던 이유다.

#### DOM (Document Object Model)
DOM 은 마크업과 1:1 관계를 갖는다.

``` html
<html>
 <body>
  <p>Hello World</p>
  <div><img src="example.png" /></div>
 </body>
</html>  
```

위의 마크업은 아래 DOM 트리로 변환할 수 있다.

```
└ HTMLhtmlElement
  └ HTMLBodyElement
    ├ HTMLParagraphElement
    |  └ Text
    └ HTMLDivElement
      └ HtmlImageElement
```

HTML 이 일반적인 상/하향식 파서로 파싱이 안되는 이유
* 언어의 너그러운 속성
* 잘 알려져 있는 HTML 오류에 대한 브라우저의 관용
* 변경에 의한 재파싱, 토큰이 동적으로 추가된다. `document.write`

따라서, [별도의 파서](https://html.spec.whatwg.org/multipage/parsing.html)를 생성한다.
> 링크만 걸고 읽어보진 않았다.

렌더링 엔진마다 오류를 자체적으로 수정하고 있다.

#### 스크립트와 스타일시트
##### 스크립트
웹은 파싱과 실행이 동시에 되는 동기화 모델이고, 웹 제작자는 파서가 `<script>` 태그를 만나면 즉시 파싱하고 실행되길 기대한다. 스크립트가 실행되는 동안 파싱은 중단된다. 스크립트를 지연(defer)로 표시할 수 있는데, 이렇게 되면 파싱이 완료된 이후 스크립트가 실행된다.

##### 스타일시트
이론적으로 스타일 시트는 DOM 트리를 변경하지 않기 때문에, 문서 파싱을 기다리거나 중단할 이유가 없다. 하지만 스크립트가 문서를 파싱하는 동안 스타일 정보를 요청하는 경우는 문제가 되고, 이런 경우가 빈번하게 발생한다.

* 파이어폭스는 로드/파싱 중인 스타일 시트가 있는 경우, 모든 스크립트의 실행을 중단한다.
* 웹킷은 로드되지 않은 스타일 시트 중 문제가 될만한 속성이 있을 때만, 스크립트의 실행을 중단한다.

#### DOM 트리와 렌더 트리의 관계
마크업은 DOM 트리와 1:1 대응하지만, 렌더러(renderer, render object) 는 DOM 트리와 1:1 로 대응하지 않는다.

`<head>` 또는 `display: none;` 같은 비시각적 DOM 요소는 렌더 트리에 추가되지 않는다.
> `visibility: hidden;` 은 나타난다.

일반적인 하나의 사각형으로 표현할 수 없는 렌더러들을 처리하는 기법들이 몇가지 있다.
* select box 표현을 위한 익명 블록렌더러
* float/absolute 처리를 위해 트리의 다른곳에 배치가 그려지지만, 자리 표시자는 원래 있어야할 곳에 배치됨.





참고
- [브라우저는 어떻게 동작하는가?](https://d2.naver.com/helloworld/59361)
